<!DOCTYPE html>
<html ng-app="xlsx">
<head>
	<title>PART</title>
	<link rel="stylesheet" href="https://raw.githack.com/awerlang/angular-responsive-tables/master/release/angular-responsive-tables.css">
	<link rel="stylesheet" href="https://raw.githack.com/WebArtWork/wcom/master/wcom-min.css">
</head>
<body>
	<div style="height: 100px;width: 100%;position: fixed; z-index: 1; 
	top: 0; left: 0; background-color: gray; overflow-y: hidden;" class="topbar">
		<div class="avatar"><a href="/waw/db/"><img width="100px" height="100px" src="https://ucea599f90e1d1735198b5714bf6.previews.dropboxusercontent.com/p/thumb/AAOXXCl5MnSeUQ3xIqFP4eAJSIwnp4AwuPSoVj4_gIInFQO36yNuWZ1ifWAn51KAXlBcdRfVP8_UUiVKnAym31uVuFcoGYx4vz1EW2_8-xkO0DqxwNAsolW37xSy0pEWBYrbCoU6G9v5wYq0JDTL0FWsH73tFIqotPLyilZ3gXuVPxKsYAGLnFIP6dJCpLmS4yWu9Om8uZ6h63FaLOimExZn1dziFgcCxaMbPnOx2B_urA/p.png?size=1600x1200&size_mode=3"></a> 
			<div style="position: fixed; top: 0%; right: 0;">
		<button ng-click="create()">New Document</button>
		<a href="/waw/db/Schema.xlsx">Download</a>
		<label>
			<span>Upload</span>
			<input type="file" import-sheet-js="" multiple="false">
		</label>
		</div>
		<button ng-if="user.is.dbadmin || user.is.dbsuper" ng-click="/waw/db/"> Back to List</button>	
			</div>
	</div>
	<div ng-controller="part" style="position: inherit; padding-top: 100px">
		<table wt-responsive-table>
			<thead>
				<tr>
					<td ng-repeat="field in fields">{{field.path}}</td>
					<td></td>
				</tr>
			</thead>
			<tbody>
				<tr ng-repeat="doc in docs">
					<td ng-repeat="field in fields" ng-click="update(editing); editing = doc;">
						<div ng-if="field.type != 'Mixed'">
							<span ng-if="editing._id != doc._id">{{doc[field.path]}}</span>
							<input  ng-model="doc[field.path]" ng-if="editing._id == doc._id" ng-change="update(doc);">
						</div>
						<div ng-if="field.type == 'Mixed'">
							<span>OBJECT PREVIEW</span>
							<button ng-click="openModal(doc, doc[field.path])">Modal</button>
						</div>
					</td>
					<td>
						<button ng-click="delete(doc); docs.splice($index, 1);">Delete</button>
					</td>
				</tr>
			</tbody>
		</table>
	</div>
	<script type="text/javascript" src="https://ajax.googleapis.com/ajax/libs/angularjs/1.7.5/angular.min.js"></script>
	<script type="text/javascript" src="https://raw.githack.com/awerlang/angular-responsive-tables/master/release/angular-responsive-tables.js"></script>
	<script type="text/javascript" src="https://raw.githack.com/WebArtWork/wcom/master/wcom-min.js"></script>
	<script src="https://rawcdn.githack.com/SheetJS/js-xlsx/1b731a3ef4366e9415591658f11130532df3adc6/dist/xlsx.full.min.js"></script>

	<script type="text/javascript">
		var app = angular.module('xlsx', ['wt.responsive', 'wcom']);
		app.controller('part', function($scope, $http, $timeout, modal, file){
			$http.get(window.location.pathname + '/get').then(function(resp) {
				$scope.fields = resp.data.fields;
				$scope.docs = resp.data.docs;
			});
			var timeout = {};
			$scope.update = function(doc){
				if(!doc||!doc._id) return;
				$timeout.cancel(timeout[doc._id]);
				timeout[doc._id] = $timeout(function(){
					$http.post(window.location.pathname + '/update', doc);
				}, 2000);
			};
			$scope.create = function(){
				$http.get(window.location.pathname + '/create').then(function(resp){
					console.log(resp.data);
					$scope.docs.push(resp.data);
				});
			};
			$scope.openModal = function(doc, field) {
				modal.open({
					templateUrl: 'modal.html',
					type: Array.isArray(field)
				});
			};
		});
		app.directive('importSheetJs', function() {
        return {
            scope: {
                opts: '='
            },
            link: function($scope, $elm) {
                $elm.on('change', function(changeEvent) {
                    var reader = new FileReader();

                    reader.onload = function(e) {

                        var bstr = e.target.result;
                        var workbook = XLSX.read(bstr, {
                            type: 'binary'
                        });
                    };

                    reader.readAsBinaryString(changeEvent.target.files[0]);
                });
            }
        };
		});
	</script>

	<script type="text/ng-template" id="modal.html">
		<div>Hello World {{type}}</div>
	</script>

</body>
</html>

