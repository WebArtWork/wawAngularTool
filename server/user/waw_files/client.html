<!DOCTYPE html>
<html ng-app="xlsx">
<head>
	<title>THIS IS OUR APP</title>
	<link rel="stylesheet" href="https://raw.githack.com/awerlang/angular-responsive-tables/master/release/angular-responsive-tables.css">
	<link rel="stylesheet" href="https://raw.githack.com/WebArtWork/wcom/master/wcom-min.css">
</head>
<body>
	<div ng-controller="main">
		<table wt-responsive-table>
			<thead>
				<tr>
					<td ng-repeat="field in fields">{{field.path}}</td>
					<td></td>
				</tr>
			</thead>
			<tbody>
				<tr ng-repeat="doc in docs">
					<td ng-repeat="field in fields" ng-click="update(editing); editing = doc;">
						<div ng-if="field.type != 'Mixed'">
							<span ng-if="editing._id != doc._id">{{doc[field.path]}}</span>
							<input  ng-model="doc[field.path]" ng-if="editing._id == doc._id" ng-change="update(doc);">
						</div>
						<div ng-if="field.type == 'Mixed'">
							<span>OBJECT PREVIEW</span>
							<button ng-click="openModal(doc, doc[field.path])">Modal</button>
						</div>
					</td>
					<td>
						<button ng-click="delete(doc); docs.splice($index, 1);">Delete</button>
					</td>
				</tr>
			</tbody>
		</table>
		<button ng-click="create()">New Document</button>
		<a href="/api/user/xlsx/User.xlsx">Download</a>
		<label>
			<span>Upload</span>
			<input type="file" ng-hide="true">
		</label>
	</div>
	<script type="text/javascript" src="https://ajax.googleapis.com/ajax/libs/angularjs/1.7.5/angular.min.js"></script>
	<script type="text/javascript" src="https://raw.githack.com/awerlang/angular-responsive-tables/master/release/angular-responsive-tables.js"></script>
	<script type="text/javascript" src="https://raw.githack.com/WebArtWork/wcom/master/wcom-min.js"></script>

	<script type="text/javascript">
		var app = angular.module('xlsx', ['wt.responsive', 'wcom']);
		app.controller('main', function($scope, $http, $timeout, modal){
			$http.get('/api/user/xlsx/get').then(function(resp) {
				$scope.fields = resp.data.fields;
				$scope.docs = resp.data.docs;
			});
			$scope.create = function(){
				$http.get('/api/user/xlsx/create').then(function(resp){
					console.log(resp.data);
					$scope.docs.push(resp.data);
				});
			};
			var timeout = {};
			$scope.update = function(doc){
				if(!doc||!doc._id) return;
				$timeout.cancel(timeout[doc._id]);
				timeout[doc._id] = $timeout(function(){
					$http.post('/api/user/xlsx/update', doc);
				}, 2000);
			};
			$scope.delete = function(doc){
				$http.post('/api/user/xlsx/delete', {
					_id: doc._id
				});
			};
			$scope.openModal = function(doc, field) {
				console.log(field);
				modal.open({
					templateUrl: 'modal.html',
					type: Array.isArray(field)
				});
			};
			$scope.read = function() {
				$http.get('/api/user/xlsx/import').then(function(resp) {
					$scope.docs.push(resp.data);
				});
			};
		});
	</script>

	<script type="text/ng-template" id="modal.html">
	    <div>Hello World {{type}}</div>

	</script>

</body>
</html>